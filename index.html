<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Braille Word Quest</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-grad: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            --primary-color: #6a11cb;
            --secondary-color: #2575fc;
            --success-color: #2ecc71;
            --warning-color: #e74c3c;
            --swap-color: #407eff;
            --text-color: #2c3e50;
            --light-text: #ffffff;
            --bg-light: rgba(255, 255, 255, 0.9);
            --bg-semi: rgba(255, 255, 255, 0.1);
            --border-color: rgba(255, 255, 255, 0.4);
            --shadow: 0 5px 15px rgba(0,0,0,0.15);
            --border-radius: 12px;
            --anim-timing: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --transition: all 0.3s ease;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background: var(--primary-grad);
            min-height: 100vh;
            color: var(--light-text);
            transition: var(--transition);
            overflow-x: hidden; /* Prevent horizontal scrolling */
            -webkit-touch-callout: none; /* Prevent callout to copy image */
            -webkit-user-select: none; /* Safari */
            -khtml-user-select: none; /* Konqueror HTML */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Non-prefixed version */
        }

        /* High Contrast Mode */
        body.high-contrast {
            --primary-grad: #000;
            --primary-color: yellow;
            --secondary-color: yellow;
            --success-color: green;
            --warning-color: #c0392b; /* Darker red */
            --swap-color: blue;
            --text-color: white;
            --bg-light: black;
            --bg-semi: #222;
            --shadow: none;
        }

        .app-container {
            max-width: 800px; 
            margin: 0 auto; 
            padding: 15px 10px;
        }

        h1 {
            text-align: center;
            font-weight: 700;
            font-size: 2.2rem;
            margin-bottom: 20px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
            letter-spacing: 1px;
            background: linear-gradient(to right, #ffffff, #a9d0fc);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 3px;
            background: linear-gradient(to right, #ffffff99, #ffffff33);
            border-radius: 2px;
        }

        body.high-contrast h1 {
            background: none;
            -webkit-background-clip: unset;
            background-clip: unset;
            -webkit-text-fill-color: var(--primary-color);
            text-shadow: none;
        }

        body.high-contrast h1::after {background: var(--primary-color);}

        /* Game Container */
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            background: var(--bg-semi);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 16px 12px;
            box-shadow: var(--shadow);
            border: 2px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        body.high-contrast .game-container {
            backdrop-filter: none;
            border: 3px solid var(--primary-color);
        }

        /* Board Layout */
        .board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 16px;
            perspective: 1000px;
            width: 100%;
            max-width: 400px;
        }

        .die {
            width: 56px;
            height: 56px;
            background: var(--bg-light);
            border-radius: var(--border-radius);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transition: transform 0.3s var(--anim-timing), box-shadow 0.3s, background-color 0.3s;
            transform-style: preserve-3d;
            border: 2px solid rgba(255, 255, 255, 0.3);
            touch-action: manipulation; /* Improve touch response */
        }

        body.high-contrast .die {
            border: 2px solid white;
            box-shadow: none;
        }

        .die:hover, .die:active {
            transform: translateY(-3px) rotateX(5deg);
            box-shadow: 0 8px 12px rgba(0,0,0,0.2), inset 0 -3px 0 rgba(0,0,0,0.1);
            background-color: #f0f9ff;
        }

        body.high-contrast .die:hover {background-color: #333; box-shadow: none;}

        .die.selected {
            background: linear-gradient(135deg, #9be15d 0%, #00e3ae 100%);
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 15px rgba(0,0,0,0.25), 0 0 15px rgba(155, 225, 93, 0.5);
        }

        body.high-contrast .die.selected {background: var(--primary-color); box-shadow: none;}

        /* Braille Display */
        .braille-cell {
            position: relative;
            width: 36px;
            height: 48px;
            transform: translateZ(5px);
        }

        .braille-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #333;
            opacity: 0.15;
            transition: var(--transition);
            box-shadow: inset 0 0 2px rgba(0,0,0,0.3);
        }

        body.high-contrast .braille-dot {background-color: white; opacity: 0.2; box-shadow: none;}

        .braille-dot.filled {
            opacity: 1;
            background-color: #333;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        body.high-contrast .braille-dot.filled {background-color: white; opacity: 1; box-shadow: none;}
        body.high-contrast .die.selected .braille-dot.filled {background-color: black;}

        /* Braille dot positions - optimized spacing */
        .braille-dot:nth-child(1) { top: 4px; left: 4px; }
        .braille-dot:nth-child(2) { top: 20px; left: 4px; }
        .braille-dot:nth-child(3) { top: 36px; left: 4px; }
        .braille-dot:nth-child(4) { top: 4px; left: 20px; }
        .braille-dot:nth-child(5) { top: 20px; left: 20px; }
        .braille-dot:nth-child(6) { top: 36px; left: 20px; }

        /* Print Letter Display */
        .print-letter {
            position: absolute;
            top: 1px;
            right: 2px;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            display: none;
            width: 14px;
            height: 14px;
            line-height: 14px;
            text-align: center;
            z-index: 5;
        }

        body.show-print-letters .print-letter {display: block;}
        body.high-contrast .print-letter {color: var(--primary-color);}
        body.high-contrast .die.selected .print-letter {color: black;}

        /* Game Controls */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 400px;
        }

        button {
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 50px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            color: white;
            text-transform: uppercase;
            box-shadow: var(--shadow);
            min-height: 48px; /* Minimum height for touch targets */
            touch-action: manipulation;
        }

        button:active {transform: translateY(2px); box-shadow: 0 2px 5px rgba(0,0,0,0.15);}

        #submit-btn {background: linear-gradient(to right, #00b09b, #96c93d);}
        #submit-btn:hover, #submit-btn:active {background: linear-gradient(to right, #00c2a8, #a5d84c); box-shadow: 0 6px 20px rgba(0,176,155,0.4);}

        #clear-btn {background: linear-gradient(to right, #ff7e5f, #feb47b);}
        #clear-btn:hover, #clear-btn:active {background: linear-gradient(to right, #ff8e73, #fec28f); box-shadow: 0 6px 20px rgba(255,126,95,0.4);}

        #new-game-btn {background: linear-gradient(to right, #4776E6, #8E54E9);}
        #new-game-btn:hover, #new-game-btn:active {background: linear-gradient(to right, #5883f7, #9d63fa); box-shadow: 0 6px 20px rgba(142,84,233,0.4);}

        #reroll-btn {background: linear-gradient(to right, #9733EE, #DA22FF);}
        #reroll-btn:hover, #reroll-btn:active {background: linear-gradient(to right, #a344ff, #e933ff); box-shadow: 0 6px 20px rgba(154,51,238,0.4);}

        button:disabled {
            background: #cfd8dc !important; 
            cursor: not-allowed; 
            box-shadow: none; 
            color: #90a4ae;
            border-color: #cfd8dc;
        }

        body.high-contrast button {
            background: var(--bg-light) !important; /* This makes all buttons black */
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            box-shadow: none;
        }

        body.high-contrast button:hover, body.high-contrast button:active {background: #333 !important; box-shadow: none;}
        body.high-contrast button:disabled {background: #333 !important; color: #666; border-color: #666;}

        /* Word Input and Display */
        .word-input {display: flex; flex-direction: column; gap: 8px; margin-bottom: 8px; width: 100%;}

        #current-word {
            font-size: 16px;
            padding: 12px;
            border-radius: var(--border-radius);
            border: 2px solid var(--border-color);
            background-color: var(--bg-light);
            min-height: 24px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
            transition: var(--transition);
            color: var(--text-color);
            font-weight: 500;
            letter-spacing: 1px;
            text-align: center;
        }

        body.high-contrast #current-word {
            background-color: var(--bg-light);
            color: white;
            border: 2px solid white;
            box-shadow: none;
        }

        /* Game Info Panel */
        .game-info {
            display: flex;
            justify-content: space-around;
            width: 100%;
            max-width: 400px;
            margin-bottom: 12px;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid var(--border-color);
        }

        body.high-contrast .game-info {background: #333; box-shadow: none; border: 2px solid white;}

        .timer, .score, .rerolls {
            font-size: 15px;
            font-weight: 700;
            color: var(--light-text);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        body.high-contrast .timer, body.high-contrast .score, body.high-contrast .rerolls {color: var(--primary-color);}

        .timer:before {content: "‚è±Ô∏è";}
        .score:before {content: "üèÜ";}
        .rerolls:before {content: "üé≤";}

        /* Word List */
        .word-list {
            width: 100%;
            max-width: 400px;
            background: var(--bg-light);
            border-radius: var(--border-radius);
            padding: 12px;
            max-height: 160px;
            overflow-y: auto;
            box-shadow: var(--shadow);
            transition: var(--transition);
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) #e0e0e0;
            position: relative;
            border: 2px solid var(--border-color);
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        body.high-contrast .word-list {background: var(--bg-light); border: 2px solid white; box-shadow: none;}

        .word-list h3 {
            margin-top: 0;
            position: sticky;
            top: 0;
            background: var(--bg-light);
            padding: 5px 0;
            margin-bottom: 8px;
            color: var(--text-color);
            font-weight: 600;
            text-align: center;
            border-bottom: 2px solid #e0e0e0;
            font-size: 16px;
        }

        body.high-contrast .word-list h3 {
            background: var(--bg-light);
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }

        .word-list ul {list-style-type: none; padding: 0; margin: 0;}

        .word-list li {
            padding: 6px 10px;
            border-radius: 6px;
            margin-bottom: 4px;
            font-weight: 500;
            color: var(--text-color);
            display: flex;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            background: rgba(255, 255, 255, 0.5);
            transition: var(--transition);
            font-size: 14px;
        }

        body.high-contrast .word-list li {background: #333; color: white; box-shadow: none;}
        
        .word-list li:hover, .word-list li:active {background: rgba(255, 255, 255, 0.8); transform: translateX(5px);}
        body.high-contrast .word-list li:hover, body.high-contrast .word-list li:active {background: #444;}

        .word-list li .word-score {color: var(--primary-color); font-weight: 700;}

        /* Notifications */
        #word-confirmation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(46, 204, 113, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 700;
            opacity: 0;
            transition: all 0.4s var(--anim-timing);
            pointer-events: none;
            z-index: 50;
            box-shadow: 0 5px 25px rgba(46, 204, 113, 0.5);
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
            max-width: 90%;
            text-align: center;
        }

        body.high-contrast #word-confirmation {
            background: var(--success-color);
            color: white;
            border: 2px solid white;
            box-shadow: none;
            text-shadow: none;
        }

        #word-confirmation.show {opacity: 1; transform: translate(-50%, -50%) scale(1.1);}

        /* Accessibility controls */
        .accessibility-controls {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
            padding: 12px 10px;
            background: var(--bg-semi);
            border-radius: 15px;
            border: 2px solid var(--border-color);
            width: 100%;
            max-width: 400px;
        }

        body.high-contrast .accessibility-controls {background: #222; border: 2px solid var(--primary-color);}

        .toggle-control, .volume-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 30px;
            background: rgba(255, 255, 255, 0.2);
            transition: var(--transition);
            border: 1px solid var(--border-color);
            min-height: 44px; /* Minimum height for touch targets */
        }

        body.high-contrast .toggle-control, body.high-contrast .volume-control {
            background: #333;
            border: 1px solid var(--primary-color);
        }

        .toggle-control:hover, .toggle-control:active, .volume-control:hover, .volume-control:active {background: rgba(255, 255, 255, 0.3);}
        body.high-contrast .toggle-control:hover, body.high-contrast .toggle-control:active, 
        body.high-contrast .volume-control:hover, body.high-contrast .volume-control:active {background: #444;}

        /* Toggle switch styling */
        .toggle-switch {position: relative; display: inline-block; width: 40px; height: 20px;}
        .toggle-switch input {opacity: 0; width: 0; height: 0;}

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        body.high-contrast .toggle-slider {background-color: #555; border: 1px solid white;}

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        body.high-contrast .toggle-slider:before {background-color: var(--primary-color);}

        input:checked + .toggle-slider {background-color: #2196F3;}
        body.high-contrast input:checked + .toggle-slider {background-color: green;}
        input:checked + .toggle-slider:before {transform: translateX(20px);}

        .toggle-label {font-size: 14px; font-weight: 500;}
        body.high-contrast .toggle-label {color: var(--primary-color);}

        /* Volume slider */
        .volume-control {
            padding-right: 16px;
        }

        .volume-slider {
            width: 80px;
            height: 10px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            outline: none;
        }

        body.high-contrast .volume-slider {background: #555; border: 1px solid white;}

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #2196F3;
            cursor: pointer;
        }

        body.high-contrast .volume-slider::-webkit-slider-thumb {background: var(--primary-color);}

        .volume-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #2196F3;
            cursor: pointer;
            border: none;
        }

        body.high-contrast .volume-slider::-moz-range-thumb {background: var(--primary-color);}

        .sound-icon {font-size: 16px; width: 20px; text-align: center;}
        body.high-contrast .sound-icon {color: var(--primary-color);}

        /* Instructions */
        .instructions-drawer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            padding: 0;
            transition: all 0.5s var(--anim-timing);
            max-height: 0;
            overflow: hidden;
            box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.2);
            z-index: 90;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }

        body.high-contrast .instructions-drawer {
            background: var(--bg-light);
            border-top: 3px solid var(--primary-color);
            border-left: 3px solid var(--primary-color);
            border-right: 3px solid var(--primary-color);
            box-shadow: none;
        }

        .instructions-drawer.open {max-height: 80vh; padding: 20px;}

        .drawer-handle {
            width: 80px;
            height: 4px;
            background: #ddd;
            border-radius: 5px;
            margin: 0 auto 15px;
            cursor: pointer;
        }

        body.high-contrast .drawer-handle {background: var(--primary-color);}

        .drawer-content {max-width: 600px; margin: 0 auto; color: var(--text-color);}
        body.high-contrast .drawer-content {color: white;}

        .drawer-content h2 {
            font-size: 20px;
            font-weight: 700;
            margin-top: 5px;
            color: var(--primary-color);
            position: relative;
            display: inline-block;
        }

        .drawer-content h2:after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            border-radius: 3px;
        }

        body.high-contrast .drawer-content h2:after {background: var(--primary-color);}

        .drawer-content p {
            font-size: 14px;
            margin: 12px 0;
            line-height: 1.4;
        }

        .drawer-content p:last-of-type {
            background: rgba(147, 51, 234, 0.1);
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid rgba(147, 51, 234, 0.5);
        }

        body.high-contrast .drawer-content p:last-of-type {
            background: #333;
            border-left: 4px solid var(--primary-color);
        }

        .drawer-toggle {
            position: fixed;
            bottom: 16px;
            right: 16px;
            width: 50px;
            height: 50px;
            background: var(--primary-grad);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(106, 17, 203, 0.4);
            z-index: 91;
            transition: var(--transition);
            border: 2px solid var(--border-color);
        }

        body.high-contrast .drawer-toggle {
            background: var(--bg-light);
            border: 2px solid var(--primary-color);
            box-shadow: none;
        }

        .drawer-toggle:hover, .drawer-toggle:active {transform: scale(1.1);}
        .drawer-toggle span {color: white; font-size: 24px; font-weight: 700;}
        body.high-contrast .drawer-toggle span {color: var(--primary-color);}

        /* End Game Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85); /* Darker background for better contrast */
            backdrop-filter: blur(5px);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        body.high-contrast .modal {background: rgba(0, 0, 0, 0.9); backdrop-filter: none;}

        .modal-content {
            background: white; /* Solid white instead of gradient for better contrast */
            padding: 20px;
            border-radius: 16px;
            max-width: 90%;
            width: 320px;
            text-align: center;
            position: relative;
            z-index: 10;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            border: 2px solid var(--border-color);
            transform: scale(0.9);
            animation: popIn 0.5s var(--anim-timing) forwards;
        }

        body.high-contrast .modal-content {
            background: var(--bg-light);
            border: 3px solid var(--primary-color);
            box-shadow: none;
        }

        /* Modal Content */
        .modal h2 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 10px;
            position: relative;
            display: inline-block;
        }

        .modal h2:after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            border-radius: 3px;
        }

        .modal p {font-size: 16px; margin: 12px 0; color: #333; font-weight: 500;} /* Darker text color */
        body.high-contrast .modal p {color: white;}
        
        /* Modal Button Styling */
        .modal button {
            margin-top: 20px;
            font-size: 16px;
            padding: 12px 25px;
            background: var(--primary-color);
            color: white;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(106, 17, 203, 0.4);
            border: none;
            font-weight: 600;
            width: 80%;
            max-width: 200px;
        }
        
        .modal button:hover, .modal button:active {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(106, 17, 203, 0.5);
            background: #7d20e3; /* Slightly lighter for hover state */
        }
        
        body.high-contrast .modal button {
            background: var(--primary-color) !important; /* Yellow with !important flag */
            color: black;
            border: 2px solid white; /* Changed from black to white for visibility */
        }

        #final-score, #words-found {
            font-size: 24px;
            font-weight: 800;
            color: #d91e18; /* Vibrant but accessible red */
            display: inline-block;
            padding: 5px 10px;
            border-radius: 10px;
            background: rgba(231, 76, 60, 0.1);
            box-shadow: 0 2px 5px rgba(231, 76, 60, 0.2);
        }

        body.high-contrast #final-score, body.high-contrast #words-found {
            color: var(--primary-color);
            background: #333;
            box-shadow: none;
        }

        #celebration-message {
            font-size: 18px;
            color: #6a11cb; /* Match our primary color */
            margin: 16px 0;
            font-weight: 700;
            padding: 8px 12px;
            background: rgba(106, 17, 203, 0.1);
            border-radius: 10px;
            display: inline-block;
        }

        body.high-contrast #celebration-message {color: var(--primary-color); background: #333;}

        /* Confetti */
        #confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            top: -20px;
            z-index: 5;
            animation: confettiFall 3s ease-in forwards;
        }

        @keyframes confettiFall {
            0% { transform: translateY(0) rotate(0deg) scale(0.8); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg) scale(1.2); opacity: 0; }
        }

        /* Animations */
        .word-item-new {animation: highlightWord 1.2s var(--anim-timing);}

        @keyframes highlightWord {
            0% { background-color: rgba(46, 204, 113, 0.8); transform: translateX(0); }
            50% { transform: translateX(10px); }
            100% { background-color: rgba(255, 255, 255, 0.5); transform: translateX(0); }
        }

        body.high-contrast .word-item-new {animation: highlightWordHighContrast 1.2s var(--anim-timing);}

        @keyframes highlightWordHighContrast {
            0% { background-color: green; transform: translateX(0); }
            50% { transform: translateX(10px); }
            100% { background-color: #333; transform: translateX(0); }
        }

        .die.changing {animation: flashChange 1s ease;}

        @keyframes flashChange {
            0%, 100% { background: var(--bg-light); }
            50% { background: rgba(255, 99, 99, 0.9); }
        }

        body.high-contrast .die.changing {animation: flashChangeHighContrast 1s ease;}

        @keyframes flashChangeHighContrast {
            0%, 100% { background: var(--bg-light); border-color: white; }
            50% { background: var(--warning-color); border-color: white; }
        }

        @keyframes diceRerollAnimation {
            0% { 
                transform: scale(1) rotate(0deg); 
                opacity: 1;
            }
            25% { 
                transform: scale(0.95) rotate(90deg); 
                opacity: 0.9;
            }
            50% { 
                transform: scale(0.9) rotate(180deg); 
                opacity: 0.8;
            }
            75% { 
                transform: scale(0.95) rotate(270deg); 
                opacity: 0.9;
            }
            100% { 
                transform: scale(1) rotate(360deg); 
                opacity: 1;
            }
        }

        .die.rerolling {animation: diceRerollAnimation 1.5s ease-in-out; z-index: 5;}
        .board.rerolling {position: relative; perspective: 1200px;}

        .die.swapping {animation: flashSwap 1s ease;}

        @keyframes flashSwap {
            0%, 100% { background: var(--bg-light); }
            50% { background: rgba(147, 51, 234, 0.9); }
        }

        body.high-contrast .die.swapping {animation: flashSwapHighContrast 1s ease;}

        @keyframes flashSwapHighContrast {
            0%, 100% { background: var(--bg-light); border-color: white; }
            50% { background: var(--swap-color); border-color: white; }
        }

        @keyframes warningShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-2px) rotate(-1deg); }
            20%, 40%, 60%, 80% { transform: translateX(2px) rotate(1deg); }
        }

        .die.warning-change {
            animation: warningShake 0.8s ease-in-out infinite;
            background: linear-gradient(to right, var(--bg-light), rgba(255, 99, 99, 0.6));
        }

        body.high-contrast .die.warning-change {
            animation: warningShake 0.8s ease-in-out infinite;
            background: var(--warning-color);
            border: 2px dashed white;
        }

        .die.warning-swap {
            animation: warningShake 0.8s ease-in-out infinite;
            background: linear-gradient(to right, var(--bg-light), rgba(64, 126, 255, 0.6));
        }

        body.high-contrast .die.warning-swap {
            animation: warningShake 0.8s ease-in-out infinite;
            background: var(--swap-color);
            border: 2px dashed white;
        }

        @keyframes savedPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(46, 204, 113, 0); }
            50% { transform: scale(1.1); box-shadow: 0 0 20px rgba(46, 204, 113, 0.8); }
            100% { transform: scale(1); box-shadow: 0 0 0 rgba(46, 204, 113, 0); }
        }

        .die.saved {
            animation: savedPulse 0.8s ease-out;
            background: linear-gradient(135deg, var(--bg-light), rgba(46, 204, 113, 0.3));
        }

        body.high-contrast .die.saved {
            animation: savedPulse 0.8s ease-out;
            background: var(--success-color);
            border: 2px solid white;
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        #screen-reader-announcer {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
            pointer-events: none;
            aria-live: polite;
        }

        /* Responsive design - improved for small screens */
        @media (max-width: 400px) {
            /* Further optimized layout for very small screens */
            .app-container {
                padding: 10px 5px;
            }
            
            h1 {
                font-size: 1.6rem;
                margin-bottom: 12px;
            }
            
            .game-container {
                padding: 12px 8px;
                gap: 12px;
            }
            
            /* Optimize the board for tiny screens */
            .board {
                gap: 4px;
                margin: 0 auto 10px;
            }
            
            /* Make dice touch-friendly but not too large */
            .die {
                width: calc((100vw - 40px) / 5);
                height: calc((100vw - 40px) / 5);
                min-width: 44px; /* Good touch target size */
                min-height: 44px;
                border-radius: 8px;
                border-width: 1px;
            }
            
            /* Adjust braille cells to fit */
            .braille-cell {
                width: calc((100vw - 70px) / 5);
                height: calc(((100vw - 70px) / 5) * 1.4);
                min-width: 28px;
                min-height: 38px;
            }
            
            /* Properly sized braille dots */
            .braille-dot {
                width: 6px;
                height: 6px;
            }
            
            /* Well-spaced braille dot positions */
            .braille-dot:nth-child(1) { top: 3px; left: 3px; }
            .braille-dot:nth-child(2) { top: 14px; left: 3px; }
            .braille-dot:nth-child(3) { top: 25px; left: 3px; }
            .braille-dot:nth-child(4) { top: 3px; left: 14px; }
            .braille-dot:nth-child(5) { top: 14px; left: 14px; }
            .braille-dot:nth-child(6) { top: 25px; left: 14px; }
            
            /* Optimize game info */
            .game-info {
                padding: 8px 12px;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .timer, .score, .rerolls {
                font-size: 14px;
            }
            
            /* More compact list */
            .word-list {
                max-height: 140px;
            }
            
            .accessibility-controls {
                padding: 10px 8px;
            }
            
            button {
                font-size: 14px;
                padding: 10px 12px;
            }
            
            /* Smaller modal for tiny screens */
            .modal-content {
                padding: 16px 12px;
            }
            
            .modal h2 {
                font-size: 20px;
            }
            
            #final-score, #words-found {
                font-size: 20px;
            }
            
            #celebration-message {
                font-size: 16px;
            }
        }

        @keyframes popIn {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* iPhone 5/SE and smaller */
        @media (max-width: 320px) {
            h1 {
                font-size: 1.4rem;
            }
            
            .die {
                min-width: 38px;
                min-height: 38px;
            }
            
            .braille-cell {
                min-width: 24px;
                min-height: 32px;
            }
            
            .braille-dot {
                width: 5px;
                height: 5px;
            }
            
            /* Even tighter layout for braille dots */
            .braille-dot:nth-child(1) { top: 2px; left: 2px; }
            .braille-dot:nth-child(2) { top: 12px; left: 2px; }
            .braille-dot:nth-child(3) { top: 22px; left: 2px; }
            .braille-dot:nth-child(4) { top: 2px; left: 12px; }
            .braille-dot:nth-child(5) { top: 12px; left: 12px; }
            .braille-dot:nth-child(6) { top: 22px; left: 12px; }
            
            button {
                font-size: 13px;
            }
            
            .timer, .score, .rerolls {
                font-size: 12px;
            }
            
            .toggle-label {
                font-size: 12px;
            }
        }

        /* Prevent text size adjustment on iOS when changing orientation */
        html {
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        /* Disable rubber-band scrolling on iOS */
        html, body {
            position: fixed;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }

        .app-container {
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* Fix for spacing issues on iOS Safari */
        @supports (-webkit-touch-callout: none) {
            .die {
                margin: 0;
            }
            
            button {
                margin: 0;
            }
        }
    </style>
    <script src="wordref.js"></script>
</head>
<body>
    <div class="app-container">
        <h1>Braille Word Quest</h1>
        
        <!-- Accessibility Controls -->
        <div class="accessibility-controls" aria-label="Accessibility options">
            <div class="toggle-control" aria-label="Toggle print letters">
                <span class="toggle-label">Show Print Letters</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="print-letters-toggle" aria-label="Show print letters">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div class="toggle-control" aria-label="Toggle high contrast mode">
                <span class="toggle-label">High Contrast</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="high-contrast-toggle" aria-label="Enable high contrast mode">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div class="volume-control" aria-label="Sound volume control">
                <span class="sound-icon" id="sound-icon">üîä</span>
                <input type="range" min="0" max="100" value="50" class="volume-slider" id="volume-slider" aria-label="Adjust sound volume">
                <span class="toggle-label">Volume</span>
            </div>
        </div>
        
        <div class="game-container" aria-label="Braille Boggle Game">
            <div class="game-info" aria-live="polite">
                <div class="timer" aria-label="Game time remaining">Time: 3:00</div>
                <div class="score" aria-label="Current score">Score: 0</div>
                <div class="rerolls" aria-label="Rerolls remaining">Rerolls: <span id="rerolls-remaining">2</span></div>
            </div>
            
            <div class="board" id="board" role="grid" aria-label="Braille game board"></div>
            
            <div class="controls">
                <div class="word-input">
                    <div id="current-word" role="textbox" aria-label="Current word" aria-live="polite"></div>
                    <button id="submit-btn" aria-label="Submit word">Submit Word</button>
                </div>
                <button id="clear-btn" aria-label="Clear selection">Clear Selection</button>
                <button id="reroll-btn" aria-label="Reroll positions">Reroll Positions</button>
                <button id="new-game-btn" aria-label="Start new game">New Game</button>
            </div>
            
            <div class="word-list" aria-label="Found words list">
                <h3>Found Words</h3>
                <ul id="word-list" aria-live="polite"></ul>
            </div>
        </div>
    </div>

    <div id="word-confirmation" aria-live="assertive"></div>
    <div id="confetti-container" aria-hidden="true"></div>
    
    <div class="drawer-toggle" id="drawer-toggle" role="button" aria-label="Open instructions" tabindex="0">
        <span>?</span>
    </div>
    
    <div class="instructions-drawer" id="instructions-drawer" aria-label="Game instructions">
        <div class="drawer-handle" id="drawer-handle" role="button" aria-label="Close instructions" tabindex="0"></div>
        <div class="drawer-content">
            <h2>How to Play</h2>
            <p>Find as many words as you can by connecting adjacent dice. Each die has a braille character on it. The braille follows uncontracted UEB (Unified English Braille) format.</p>
            <p>Click on dice to form words. Words must be at least 3 letters long. Click "Submit Word" when you've found a word.</p>
            <p>You can reroll the dice twice per game to scramble their positions (the letters remain the same).</p>
            <p>The game runs for 3 minutes. Good luck!</p>
            <p><strong>Note:</strong> You can toggle print letter hints using the accessibility controls at the top of the page.</p>
            <p><strong>Challenge:</strong> Every 10 seconds, one random die will change its letter! Every 8 seconds, two adjacent tiles will swap positions!</p>
        </div>
    </div>
    
    <div class="modal" id="game-over-modal" role="dialog" aria-labelledby="game-over-title" aria-hidden="true">
        <div class="modal-content">
            <h2 id="game-over-title">Time's Up!</h2>
            <p id="celebration-message" aria-live="polite">Well done!</p>
            <p>Your final score: <span id="final-score" aria-live="polite">0</span></p>
            <p>Words found: <span id="words-found" aria-live="polite">0</span></p>
            <button id="play-again-btn" aria-label="Play again">Play Again</button>
        </div>
    </div>
    
    <!-- Screen reader announcer -->
    <div id="screen-reader-announcer" aria-live="polite"></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Game data
            const boggleDice = [
                'AACIOT', 'ABILTY', 'ABJMOQ', 'ACDEMP', 'ACELRS', 'ADENVZ', 'AHMORS', 'BIFORX', 'DENOSW', 'DKNOTU',
                'EEFHIY', 'EGKLUY', 'EGINTV', 'EHINPS', 'ELPSTU', 'GILRUW', 'AAEEGN', 'ABBJOO', 'ACHOPS', 'AFFKPS',
                'AOOTTW', 'CIMOTU', 'DEILRX', 'DELRVY', 'DISTTY'
            ];
            
            // UEB Braille patterns
            const braillePatterns = {
                'A': [1], 'B': [1, 2], 'C': [1, 4], 'D': [1, 4, 5], 'E': [1, 5], 'F': [1, 2, 4], 'G': [1, 2, 4, 5], 'H': [1, 2, 5],
                'I': [2, 4], 'J': [2, 4, 5], 'K': [1, 3], 'L': [1, 2, 3], 'M': [1, 3, 4], 'N': [1, 3, 4, 5], 'O': [1, 3, 5], 'P': [1, 2, 3, 4],
                'Q': [1, 2, 3, 4, 5], 'R': [1, 2, 3, 5], 'S': [2, 3, 4], 'T': [2, 3, 4, 5], 'U': [1, 3, 6], 'V': [1, 2, 3, 6], 
                'W': [2, 4, 5, 6], 'X': [1, 3, 4, 6], 'Y': [1, 3, 4, 5, 6], 'Z': [1, 3, 5, 6]
            };
            
            // Game state variables
            let board = [];
            let selectedDice = [];
            let currentWord = '';
            let foundWords = [];
            let score = 0;
            let gameTimer;
            let timeLeft = 180; // 3 minutes
            let rerollsRemaining = 2;
            let randomChangeTimer;
            let validWords = [];
            let swapTimer;
            let warningTimeouts = {};
            
            // Accessibility state variables
            let showPrintLetters = false;
            let highContrastMode = false;
            let soundVolume = 0.5;
            let soundMuted = false;

            // Audio context
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            const audioContext = new AudioContext();
            
            // DOM elements
            const boardElement = document.getElementById('board');
            const currentWordElement = document.getElementById('current-word');
            const submitBtn = document.getElementById('submit-btn');
            const clearBtn = document.getElementById('clear-btn');
            const newGameBtn = document.getElementById('new-game-btn');
            const rerollBtn = document.getElementById('reroll-btn');
            const rerollCountElement = document.getElementById('rerolls-remaining');
            const wordListElement = document.getElementById('word-list');
            const timerElement = document.querySelector('.timer');
            const scoreElement = document.querySelector('.score');
            const gameOverModal = document.getElementById('game-over-modal');
            const finalScoreElement = document.getElementById('final-score');
            const wordsFoundElement = document.getElementById('words-found');
            const playAgainBtn = document.getElementById('play-again-btn');
            
            // Accessibility DOM elements
            const printLettersToggle = document.getElementById('print-letters-toggle');
            const highContrastToggle = document.getElementById('high-contrast-toggle');
            const volumeSlider = document.getElementById('volume-slider');
            const soundIcon = document.getElementById('sound-icon');
            const screenReaderAnnouncer = document.getElementById('screen-reader-announcer');
            
            // Fix for iOS rubber-band scrolling
            document.body.addEventListener('touchmove', function(e) {
                if (e.target.classList.contains('volume-slider') || 
                    e.target.classList.contains('word-list') || 
                    e.target.closest('.word-list')) {
                    return;
                }
                e.preventDefault();
            }, { passive: false });
            
            // Initialize 
            initAccessibilityControls();
            initGame();
            
            // Load word list
            function loadWordList() {
                try {
                    if (typeof WORD_LIST !== 'undefined') {
                        validWords = WORD_LIST.map(word => word.trim().toUpperCase());
                        console.log(`Loaded ${validWords.length} valid words`);
                    } else {
                        throw new Error("Word list not available");
                    }
                } catch (error) {
                    console.error('Error loading word list:', error);
                    validWords = ['CAT', 'DOG', 'PET', 'HAT', 'LEG', 'LET', 'GET', 'GOT'];
                }
            }
            
            // Initialize accessibility controls
            function initAccessibilityControls() {
                // Print letters toggle
                printLettersToggle.addEventListener('change', function() {
                    showPrintLetters = this.checked;
                    document.body.classList.toggle('show-print-letters', showPrintLetters);
                    announceToScreenReader(showPrintLetters ? "Print letters are now visible." : "Print letters are now hidden.");
                });
                
                // High contrast mode toggle
                highContrastToggle.addEventListener('change', function() {
                    highContrastMode = this.checked;
                    document.body.classList.toggle('high-contrast', highContrastMode);
                    announceToScreenReader(highContrastMode ? "High contrast mode enabled." : "High contrast mode disabled.");
                });
                
                // Volume slider
                volumeSlider.addEventListener('input', function() {
                    soundVolume = this.value / 100;
                    if (soundVolume === 0) {
                        soundMuted = true;
                        soundIcon.textContent = 'üîá';
                    } else {
                        soundMuted = false;
                        soundIcon.textContent = soundVolume < 0.3 ? 'üîà' : soundVolume < 0.7 ? 'üîâ' : 'üîä';
                    }
                });
                
                // Sound icon toggle mute
                soundIcon.addEventListener('click', function() {
                    soundMuted = !soundMuted;
                    if (soundMuted) {
                        soundIcon.textContent = 'üîá';
                        announceToScreenReader("Sound muted.");
                    } else {
                        if (soundVolume === 0) soundVolume = 0.5;
                        volumeSlider.value = soundVolume * 100;
                        soundIcon.textContent = soundVolume < 0.3 ? 'üîà' : soundVolume < 0.7 ? 'üîâ' : 'üîä';
                        announceToScreenReader("Sound unmuted.");
                    }
                });
            }
            
            // Function to announce messages to screen readers
            function announceToScreenReader(message) {
                screenReaderAnnouncer.textContent = message;
            }
            
            // Initialize game
            function initGame() {
                // Reset game state
                board = [];
                selectedDice = [];
                currentWord = '';
                foundWords = [];
                score = 0;
                timeLeft = 180;
                rerollsRemaining = 2;
                
                console.log("Starting new game...");
                
                // Load word list if not already loaded
                if (validWords.length === 0) loadWordList();
                
                // Update UI
                currentWordElement.textContent = '';
                wordListElement.innerHTML = '';
                scoreElement.textContent = 'Score: 0';
                timerElement.textContent = 'Time: 3:00';
                updateRerollCounter();
                
                // Clear timers
                [gameTimer, randomChangeTimer, swapTimer].forEach(timer => {
                    if (timer) {
                        clearInterval(timer);
                        console.log("Cleared timer:", timer);
                    }
                });
                
                // Generate board and start timers
                generateBoard();
                renderBoard();
                startTimer();
                startRandomChangeTimer();
                startSwapTimer();
                
                // Enable buttons
                updateRerollButton();
                submitBtn.disabled = false;
                clearBtn.disabled = false;
                
                announceToScreenReader("New game started. The board has been generated with 25 braille letters. Find words by selecting adjacent tiles.");
            }
            
            // Generate board
            function generateBoard() {
                // Shuffle the dice
                const shuffledDice = [...boggleDice].sort(() => Math.random() - 0.5);
                
                // Create a 5x5 board with random faces of the dice
                for (let i = 0; i < 25; i++) {
                    const die = shuffledDice[i];
                    const randomFace = die.charAt(Math.floor(Math.random() * die.length));
                    board.push(randomFace);
                }
            }
            
            // Render board
            function renderBoard() {
                boardElement.innerHTML = '';
                
                for (let i = 0; i < 25; i++) {
                    const letter = board[i];
                    const dieElement = document.createElement('div');
                    dieElement.className = 'die';
                    dieElement.dataset.index = i;
                    dieElement.setAttribute('role', 'gridcell');
                    dieElement.setAttribute('aria-label', `Letter ${letter} in braille`);
                    dieElement.setAttribute('tabindex', '0');
                    
                    // Create braille cell
                    const brailleCell = document.createElement('div');
                    brailleCell.className = 'braille-cell';
                    
                    for (let dot = 1; dot <= 6; dot++) {
                        const dotElement = document.createElement('div');
                        dotElement.className = 'braille-dot';
                        if (braillePatterns[letter] && braillePatterns[letter].includes(dot)) {
                            dotElement.classList.add('filled');
                        }
                        brailleCell.appendChild(dotElement);
                    }
                    
                    // Add print letter display
                    const printLetter = document.createElement('div');
                    printLetter.className = 'print-letter';
                    printLetter.textContent = letter;
                    printLetter.setAttribute('aria-hidden', 'true');
                    
                    dieElement.appendChild(brailleCell);
                    dieElement.appendChild(printLetter);
                    boardElement.appendChild(dieElement);
                    
                    // Add click event
                    dieElement.addEventListener('click', handleDieClick);
                    dieElement.addEventListener('touchstart', function(e) {
                        // Prevent zoom on double-tap for iOS
                        e.preventDefault();
                    }, false);
                    
                    // Keyboard support
                    dieElement.addEventListener('keydown', e => {
                        if (e.key === 'Enter' || e.key === ' ') handleDieClick(e);
                    });
                }
            }
            
            // Update die
            function updateDie(index, newLetter) {
                const dieElement = document.querySelector(`.die[data-index="${index}"]`);
                if (!dieElement) return;
                
                dieElement.setAttribute('aria-label', `Letter ${newLetter} in braille`);
                
                // Update braille
                const brailleCell = dieElement.querySelector('.braille-cell');
                brailleCell.innerHTML = '';
                
                for (let dot = 1; dot <= 6; dot++) {
                    const dotElement = document.createElement('div');
                    dotElement.className = 'braille-dot';
                    if (braillePatterns[newLetter] && braillePatterns[newLetter].includes(dot)) {
                        dotElement.classList.add('filled');
                    }
                    brailleCell.appendChild(dotElement);
                }
                
                // Update print letter
                const printLetter = dieElement.querySelector('.print-letter');
                if (printLetter) printLetter.textContent = newLetter;
                
                // Animation
                dieElement.classList.add('changing');
                setTimeout(() => dieElement.classList.remove('changing'), 1000);
            }
            
            // Random letter change
            function randomLetterChange() {
                // Select random die not currently selected
                let availableDice = [];
                for (let i = 0; i < 25; i++) {
                    if (!selectedDice.includes(i)) availableDice.push(i);
                }
                
                if (availableDice.length === 0) return;
                
                const randomIndex = availableDice[Math.floor(Math.random() * availableDice.length)];
                const dieLetter = board[randomIndex];
                
                // Add warning
                const dieElement = document.querySelector(`.die[data-index="${randomIndex}"]`);
                dieElement.classList.add('warning-change');
                dieElement.dataset.warning = 'change';
                
                dieElement.setAttribute('aria-label', `Warning: Letter ${dieLetter} in braille is about to change. Click to prevent change.`);
                
                announceToScreenReader(`Warning: A letter is about to change at position ${randomIndex + 1}. Click to prevent change.`);
                
                playSound('warningChange');
                
                warningTimeouts[randomIndex] = setTimeout(() => {
                    if (dieElement.classList.contains('warning-change')) {
                        dieElement.classList.remove('warning-change');
                        delete dieElement.dataset.warning;
                        
                        // Generate new letter
                        const allLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                        let newLetters = allLetters.replace(dieLetter, '');
                        const newLetter = newLetters.charAt(Math.floor(Math.random() * newLetters.length));
                        
                        board[randomIndex] = newLetter;
                        updateDie(randomIndex, newLetter);
                        playSound('letterChange');
                        
                        announceToScreenReader(`Letter at position ${randomIndex + 1} changed from ${dieLetter} to ${newLetter}.`);
                    }
                }, 3000);
            }
            
            // Start random letter change timer
            function startRandomChangeTimer() {
                randomChangeTimer = setInterval(randomLetterChange, 10000);
            }
            
            // Handle die click
            function handleDieClick(event) {
                const dieElement = event.currentTarget;
                const index = parseInt(dieElement.dataset.index);
                
                // Check if warning state
                if (dieElement.dataset.warning) {
                    const warningType = dieElement.dataset.warning;
                    let partnerIndex = null; // Initialize variable outside the if block
                    
                    // Cancel pending change/swap
                    if (warningTimeouts[index]) {
                        clearTimeout(warningTimeouts[index]);
                        delete warningTimeouts[index];
                    }
                    
                    // If swap, cancel partner
                    if (warningType === 'swap' && dieElement.dataset.swapPartner) {
                        partnerIndex = parseInt(dieElement.dataset.swapPartner);
                        const partnerElement = document.querySelector(`.die[data-index="${partnerIndex}"]`);
                        
                        if (partnerElement) {
                            partnerElement.classList.remove('warning-swap');
                            delete partnerElement.dataset.warning;
                            delete partnerElement.dataset.swapPartner;
                            
                            partnerElement.setAttribute('aria-label', `Letter ${board[partnerIndex]} in braille`);
                            
                            if (warningTimeouts[partnerIndex]) {
                                clearTimeout(warningTimeouts[partnerIndex]);
                                delete warningTimeouts[partnerIndex];
                            }
                        }
                    }
                    
                    // Remove warning
                    dieElement.classList.remove('warning-change', 'warning-swap');
                    delete dieElement.dataset.warning;
                    
                    dieElement.setAttribute('aria-label', `Letter ${board[index]} in braille`);
                    
                    // Saved animation
                    dieElement.classList.add('saved');
                    setTimeout(() => dieElement.classList.remove('saved'), 800);
                    
                    playSound('tileSaved');
                    
                    // Fixed announcement with conditional check for partnerIndex
                    announceToScreenReader(warningType === 'change' 
                        ? `Change prevented for letter at position ${index + 1}.`
                        : `Swap prevented for letters at positions ${index + 1}${partnerIndex !== null ? ` and ${partnerIndex + 1}` : ''}.`);
                    
                    return;
                }
                
                // Selection logic
                if (selectedDice.includes(index)) return;
                
                // Check adjacency
                if (selectedDice.length > 0) {
                    const lastIndex = selectedDice[selectedDice.length - 1];
                    if (!isAdjacent(lastIndex, index)) {
                        announceToScreenReader("This tile is not adjacent to your last selection.");
                        return;
                    }
                }
                
                // Add to selected
                selectedDice.push(index);
                dieElement.classList.add('selected');
                dieElement.setAttribute('aria-selected', 'true');
                
                // Update word
                currentWord += board[index];
                currentWordElement.textContent = currentWord;
                
                // Provide haptic feedback on supported devices
                if (navigator.vibrate) {
                    navigator.vibrate(20);
                }
                
                announceToScreenReader(`Added letter ${board[index]}. Current word: ${currentWord}.`);
            }
            
            // Check adjacency
            function isAdjacent(index1, index2) {
                const row1 = Math.floor(index1 / 5);
                const col1 = index1 % 5;
                const row2 = Math.floor(index2 / 5);
                const col2 = index2 % 5;
                
                return Math.abs(row1 - row2) <= 1 && Math.abs(col1 - col2) <= 1;
            }
            
            // Clear selection
            function clearSelection() {
                selectedDice.forEach(index => {
                    const dieElement = document.querySelector(`.die[data-index="${index}"]`);
                    if (dieElement) {
                        dieElement.classList.remove('selected');
                        dieElement.setAttribute('aria-selected', 'false');
                    }
                });
                
                selectedDice = [];
                currentWord = '';
                currentWordElement.textContent = '';
                
                announceToScreenReader("Selection cleared.");
            }
            
            // Submit word
            function submitWord() {
                // Validate word
                if (currentWord.length < 3) {
                    announceToScreenReader("Words must be at least 3 letters long.");
                    alert('Words must be at least 3 letters long.');
                    return;
                }
                
                if (foundWords.includes(currentWord)) {
                    announceToScreenReader("You already found this word!");
                    alert('You already found this word!');
                    clearSelection();
                    return;
                }
                
                // Check if valid
                if (!validWords.includes(currentWord)) {
                    const confirmationElement = document.getElementById('word-confirmation');
                    confirmationElement.textContent = `"${currentWord}" is not a valid word!`;
                    confirmationElement.style.background = 'rgba(231, 76, 60, 0.9)';
                    confirmationElement.style.boxShadow = '0 5px 25px rgba(231, 76, 60, 0.5)';
                    confirmationElement.classList.add('show');
                    
                    announceToScreenReader(`"${currentWord}" is not a valid word!`);
                    
                    setTimeout(() => confirmationElement.classList.remove('show'), 1500);
                    
                    clearSelection();
                    return;
                }
                
                // Add to found words
                foundWords.push(currentWord);
                
                // Update score
                const wordScore = calculateWordScore(currentWord);
                score += wordScore;
                scoreElement.textContent = `Score: ${score}`;
                
                // Add to word list
                addWordToList(currentWord, wordScore);
                
                // Show confirmation
                showWordConfirmation(currentWord, wordScore);
                
                playSound('wordFound');
                
                // Provide haptic feedback on supported devices
                if (navigator.vibrate) {
                    navigator.vibrate([30, 20, 30]);
                }
                
                announceToScreenReader(`Word "${currentWord}" found! You earned ${wordScore} points. Your total score is now ${score}.`);
                
                clearSelection();
            }
            
            // Add word to list
            function addWordToList(word, score) {
                const wordItem = document.createElement('li');
                const wordText = document.createElement('span');
                wordText.textContent = word;
                
                const wordScore = document.createElement('span');
                wordScore.textContent = `+${score}`;
                wordScore.className = 'word-score';
                
                wordItem.appendChild(wordText);
                wordItem.appendChild(wordScore);
                wordItem.className = 'word-item-new';
                wordListElement.appendChild(wordItem);
                
                setTimeout(() => wordItem.className = '', 1200);
            }
            
            // Show word confirmation
            function showWordConfirmation(word, score) {
                const confirmationElement = document.getElementById('word-confirmation');
                confirmationElement.textContent = `${word}: +${score} points!`;
                confirmationElement.style.background = 'rgba(46, 204, 113, 0.9)';
                confirmationElement.style.boxShadow = '0 5px 25px rgba(46, 204, 113, 0.5)';
                confirmationElement.classList.add('show');
                
                setTimeout(() => {
                    confirmationElement.classList.remove('show');
                    confirmationElement.style.background = '';
                    confirmationElement.style.boxShadow = '';
                }, 1500);
            }
            
            // Reroll dice
            function rerollDice() {
                if (rerollsRemaining <= 0) return;
                
                clearSelection();
                playSound('reroll');
                
                // Provide haptic feedback on supported devices
                if (navigator.vibrate) {
                    navigator.vibrate([20, 20, 40, 20, 60]);
                }
                
                announceToScreenReader("Rerolling dice positions. Letters will remain the same but positions will change.");
                
                boardElement.classList.add('rerolling');
                
                // Animate dice with gentler transitions
                const diceElements = document.querySelectorAll('.die');
                diceElements.forEach((die, index) => {
                    die.classList.add('rerolling');
                    
                    // More subtle color change with pastel hues
                    const randomHue = Math.floor(Math.random() * 360);
                    die.style.background = `hsla(${randomHue}, 70%, 85%, 0.9)`;
                    
                    // More subtle movement - reduce by 50%
                    const randomX = (Math.random() - 0.5) * 30;
                    const randomY = (Math.random() - 0.5) * 30;
                    const randomZ = Math.random() * 50;
                    die.style.transform = `translate3d(${randomX}px, ${randomY}px, ${randomZ}px)`;
                    
                    // Smoother transitions with easing
                    setTimeout(() => {
                        die.style.transition = 'all 1.2s cubic-bezier(0.34, 1.56, 0.64, 1)';
                    }, index * 10); // Reduced staggering
                });
                
                // After animation
                setTimeout(() => {
                    // Shuffle board
                    shuffleArray(board);
                    
                    // Reset dice with a gentle transition
                    diceElements.forEach(die => {
                        die.style.transform = '';
                        die.style.background = '';
                        die.style.transition = 'all 0.5s ease-out';
                        die.classList.remove('rerolling');
                    });
                    
                    boardElement.classList.remove('rerolling');
                    renderBoard();
                    
                    // Update rerolls
                    rerollsRemaining--;
                    updateRerollCounter();
                    updateRerollButton();
                    
                    announceToScreenReader(`Positions scrambled! You have ${rerollsRemaining} reroll${rerollsRemaining === 1 ? '' : 's'} remaining.`);
                }, 1200); // Slightly shorter animation
            }
            
            // Shuffle array with fixed algorithm
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }
            
            // Update reroll counter
            function updateRerollCounter() {
                rerollCountElement.textContent = rerollsRemaining;
            }
            
            // Update reroll button
            function updateRerollButton() {
                rerollBtn.disabled = rerollsRemaining <= 0;
                rerollBtn.setAttribute('aria-label', rerollsRemaining <= 0 ? 
                    'No rerolls remaining' : `Reroll positions (${rerollsRemaining} remaining)`);
            }
            
            // Calculate word score
            function calculateWordScore(word) {
                if (word.length === 3) return 1;
                if (word.length === 4) return 1;
                if (word.length === 5) return 2;
                if (word.length === 6) return 3;
                if (word.length === 7) return 5;
                return 11; // 8+ letters
            }
            
            // Start timer
            function startTimer() {
                gameTimer = setInterval(function() {
                    timeLeft--;
                    
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerElement.textContent = `Time: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    // Announce time milestones
                    if ([60, 30, 10].includes(timeLeft)) {
                        announceToScreenReader(`${timeLeft === 60 ? 'One minute' : timeLeft} seconds remaining.`);
                    }
                    
                    if (timeLeft <= 0) endGame();
                }, 1000);
            }
            
            // End game
            function endGame() {
                // Clear timers
                [gameTimer, randomChangeTimer, swapTimer].forEach(timer => timer && clearInterval(timer));
                
                playSound('gameOver');
                createConfetti();
                
                // Get message
                const celebrationMessage = getCelebrationMessage(score);
                
                // Update modal
                finalScoreElement.textContent = score;
                wordsFoundElement.textContent = foundWords.length;
                document.getElementById('celebration-message').textContent = celebrationMessage;
                gameOverModal.style.display = 'flex';
                
                // Disable board
                document.querySelectorAll('.die').forEach(die => {
                    die.removeEventListener('click', handleDieClick);
                    die.setAttribute('aria-disabled', 'true');
                    die.setAttribute('tabindex', '-1');
                });
                
                submitBtn.disabled = true;
                clearBtn.disabled = true;
                rerollBtn.disabled = true;
                
                // Provide haptic feedback on supported devices
                if (navigator.vibrate) {
                    navigator.vibrate([40, 30, 40, 30, 80]);
                }
                
                announceToScreenReader(`Game over! Your final score is ${score} points with ${foundWords.length} words found. ${celebrationMessage}`);
            }
            
            // Get celebration message
            function getCelebrationMessage(score) {
                if (score >= 50) return "Amazing job! You're a braille master!";
                if (score >= 30) return "Great work! Your braille skills are impressive!";
                if (score >= 15) return "Well done! You're getting good at braille!";
                return "Good effort! Keep practicing your braille skills!";
            }
            
            // Create confetti
            function createConfetti() {
                const confettiContainer = document.getElementById('confetti-container');
                confettiContainer.innerHTML = '';
                
                // Use fewer confetti pieces on mobile to prevent performance issues
                const confettiCount = window.innerWidth < 500 ? 75 : 150;
                
                for (let i = 0; i < confettiCount; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    
                    const color = `hsl(${Math.random() * 360}, 100%, 50%)`;
                    const left = Math.random() * 100;
                    const size = Math.random() * 8 + 4; // Smaller sizes for mobile
                    const duration = Math.random() * 2.5 + 2.5;
                    const delay = Math.random() * 1.5;
                    
                    const shapes = ['50%', '0%', '50% 0 0 50%'];
                    const shape = shapes[Math.floor(Math.random() * shapes.length)];
                    
                    Object.assign(confetti.style, {
                        background: color,
                        left: `${left}%`,
                        width: `${size}px`,
                        height: `${size}px`,
                        borderRadius: shape,
                        animation: `confettiFall ${duration}s ease-in ${delay}s forwards`
                    });
                    
                    confettiContainer.appendChild(confetti);
                }
            }
            
            // Play sound with softer effects
            function playSound(type) {
                if (soundMuted) return;
                
                // Try to ensure AudioContext is running on iOS
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                const volume = soundVolume * 0.5; // Reduce overall volume for mobile
                const currentTime = audioContext.currentTime;
                
                // Different sound types
                const soundSettings = {
                    'wordFound': () => {
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(440, currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(880, currentTime + 0.1);
                        
                        gainNode.gain.setValueAtTime(0.15 * volume, currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01 * volume, currentTime + 0.3);
                        
                        oscillator.start();
                        oscillator.stop(currentTime + 0.3);
                    },
                    'gameOver': () => {
                        oscillator.type = 'triangle';
                        gainNode.gain.linearRampToValueAtTime(0.15 * volume, currentTime + 0.05);
                        gainNode.gain.exponentialRampToValueAtTime(0.01 * volume, currentTime + 0.3);
                        
                        oscillator.start();
                        oscillator.stop(currentTime + 0.3);
                    },
                    'warningChange': () => {
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(550, currentTime);
                        oscillator.frequency.linearRampToValueAtTime(380, currentTime + 0.2);
                        
                        gainNode.gain.setValueAtTime(0.06 * volume, currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01 * volume, currentTime + 0.3);
                        
                        oscillator.start();
                        oscillator.stop(currentTime + 0.3);
                    },
                    'warningSwap': () => {
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(350, currentTime);
                        oscillator.frequency.linearRampToValueAtTime(280, currentTime + 0.2);
                        
                        gainNode.gain.setValueAtTime(0.06 * volume, currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01 * volume, currentTime + 0.3);
                        
                        oscillator.start();
                        oscillator.stop(currentTime + 0.3);
                    },
                    'tileSaved': () => {
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(700, currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(1400, currentTime + 0.1);
                        
                        gainNode.gain.setValueAtTime(0.12 * volume, currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01 * volume, currentTime + 0.3);
                        
                        oscillator.start();
                        oscillator.stop(currentTime + 0.3);
                    },
                    'reroll': () => {
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(600, currentTime);
                        oscillator.frequency.linearRampToValueAtTime(300, currentTime + 0.3);
                        
                        gainNode.gain.setValueAtTime(0.10 * volume, currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01 * volume, currentTime + 0.4);
                        
                        oscillator.start();
                        oscillator.stop(currentTime + 0.4);
                    }
                };
                
                // Play the sound
                if (soundSettings[type]) soundSettings[type]();
            }
            
            // Modified swap adjacent tiles to skip the popup
            function swapAdjacentTiles() {
                // Log when swap attempt is triggered for debugging
                console.log("Swap timer triggered at: " + new Date().toISOString());
                
                if (board.length < 2) return;
                
                // Find random adjacent tiles
                const index1 = Math.floor(Math.random() * 25);
                const row1 = Math.floor(index1 / 5);
                const col1 = index1 % 5;
                
                // Get adjacent positions
                const adjacentPositions = [];
                
                for (let r = Math.max(0, row1 - 1); r <= Math.min(4, row1 + 1); r++) {
                    for (let c = Math.max(0, col1 - 1); c <= Math.min(4, col1 + 1); c++) {
                        const adjIndex = r * 5 + c;
                        if (adjIndex !== index1) adjacentPositions.push(adjIndex);
                    }
                }
                
                if (adjacentPositions.length === 0) return;
                
                const index2 = adjacentPositions[Math.floor(Math.random() * adjacentPositions.length)];
                
                // Get dice
                const die1 = document.querySelector(`.die[data-index="${index1}"]`);
                const die2 = document.querySelector(`.die[data-index="${index2}"]`);
                
                if (!die1 || !die2) return;
                
                // Add warning class to both dice
                die1.classList.add('warning-swap');
                die1.dataset.warning = 'swap';
                die1.dataset.swapPartner = index2;
                
                die2.classList.add('warning-swap');
                die2.dataset.warning = 'swap';
                die2.dataset.swapPartner = index1;
                
                // Update ARIA
                die1.setAttribute('aria-label', `Warning: Letter ${board[index1]} in braille is about to swap with letter ${board[index2]}. Click to prevent swap.`);
                die2.setAttribute('aria-label', `Warning: Letter ${board[index2]} in braille is about to swap with letter ${board[index1]}. Click to prevent swap.`);
                
                announceToScreenReader(`Warning: Two letters are about to swap at positions ${index1 + 1} and ${index2 + 1}. Click either one to prevent the swap.`);
                
                playSound('warningSwap');
                
                // Set timeout
                const swapTimeout = setTimeout(() => {
                    if (die1.classList.contains('warning-swap') && die2.classList.contains('warning-swap')) {
                        // Remove warnings
                        die1.classList.remove('warning-swap');
                        delete die1.dataset.warning;
                        delete die1.dataset.swapPartner;
                        
                        die2.classList.remove('warning-swap');
                        delete die2.dataset.warning;
                        delete die2.dataset.swapPartner;
                        
                        // Swap letters
                        [board[index1], board[index2]] = [board[index2], board[index1]];
                        
                        // Update visuals
                        updateDie(index1, board[index1]);
                        updateDie(index2, board[index2]);
                        
                        // Animation
                        die1.classList.add('swapping');
                        die2.classList.add('swapping');
                        
                        setTimeout(() => {
                            die1.classList.remove('swapping');
                            die2.classList.remove('swapping');
                        }, 1000);
                        
                        // Provide haptic feedback on supported devices
                        if (navigator.vibrate) {
                            navigator.vibrate([15, 15, 15]);
                        }
                        
                        // Skip showing the swap confirmation popup
                        console.log("Tiles swapped successfully! Next swap in 8 seconds.");
                        
                        announceToScreenReader(`Letters swapped at positions ${index1 + 1} and ${index2 + 1}.`);
                    }
                }, 3000);
                
                // Store timeouts
                warningTimeouts[index1] = swapTimeout;
                warningTimeouts[index2] = swapTimeout;
            }
            
            // Start swap timer with exactly 8 second interval
            function startSwapTimer() {
                // Clear any existing swap timer first
                if (swapTimer) {
                    clearInterval(swapTimer);
                    console.log("Cleared previous swap timer");
                }
                
                // Create new timer with EXACTLY 8000ms interval - this is critical
                swapTimer = setInterval(function() {
                    console.log("8-SECOND SWAP TIMER FIRED at " + new Date().toTimeString());
                    swapAdjacentTiles();
                }, 8000);
                
                // Log definitive confirmation
                console.log("NEW SWAP TIMER STARTED WITH 8-SECOND INTERVAL at " + new Date().toTimeString());
                console.log("Next swap will occur in exactly 8 seconds");
                
                // First swap happens after a delay to confirm timer
                setTimeout(function() {
                    console.log("PERFORMING INITIAL SWAP");
                    swapAdjacentTiles();
                }, 3000);
            }
            
            // Instructions drawer
            const drawerToggle = document.getElementById('drawer-toggle');
            const drawerHandle = document.getElementById('drawer-handle');
            const instructionsDrawer = document.getElementById('instructions-drawer');
            
            drawerToggle.addEventListener('click', function() {
                instructionsDrawer.classList.toggle('open');
                
                if (instructionsDrawer.classList.contains('open')) {
                    drawerToggle.setAttribute('aria-expanded', 'true');
                    announceToScreenReader("Instructions panel opened.");
                } else {
                    drawerToggle.setAttribute('aria-expanded', 'false');
                    announceToScreenReader("Instructions panel closed.");
                }
            });
            
            // Add touch events for better mobile experience
            drawerToggle.addEventListener('touchend', function(e) {
                e.preventDefault(); // Prevent default to avoid delays
                this.click();
            });
            
            drawerHandle.addEventListener('click', () => {
                instructionsDrawer.classList.remove('open');
                drawerToggle.setAttribute('aria-expanded', 'false');
                announceToScreenReader("Instructions panel closed.");
            });
            
            drawerHandle.addEventListener('touchend', function(e) {
                e.preventDefault();
                this.click();
            });
            
            // Game control events
            submitBtn.addEventListener('click', submitWord);
            clearBtn.addEventListener('click', clearSelection);
            newGameBtn.addEventListener('click', initGame);
            rerollBtn.addEventListener('click', rerollDice);
            playAgainBtn.addEventListener('click', () => {
                gameOverModal.style.display = 'none';
                initGame();
            });
            
            // Add touch events for better mobile response
            [submitBtn, clearBtn, newGameBtn, rerollBtn, playAgainBtn].forEach(btn => {
                btn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    if (!this.disabled) {
                        this.click();
                    }
                });
            });
            
            // Force reset the swap timer to ensure 8-second interval
            function forceResetSwapTimer() {
                console.log("Forcing reset of swap timer to 8-second interval");
                if (swapTimer) {
                    clearInterval(swapTimer);
                }
                swapTimer = setInterval(swapAdjacentTiles, 8000);
                
                // Log to verify timer is reset
                console.log("Swap timer reset complete. Next swap in 8 seconds.");
            }
            
            // Call this function after page load to ensure correct interval
            setTimeout(forceResetSwapTimer, 2000);
            
            // Fix for iOS and Android touch device issues - prevent zooming on double-tap
            document.addEventListener('dblclick', function(e) {
                e.preventDefault();
            }, { passive: false });
            
            // Allow scrolling only within scrollable elements
            document.querySelectorAll('.word-list').forEach(el => {
                el.addEventListener('touchmove', function(e) {
                    e.stopPropagation();
                }, { passive: true });
            });
            
            // Initialize with a direct update to the instructions text
            window.onload = function() {
                // Update the instructions text to explicitly mention 8-second swaps
                const instructionsContent = document.querySelector('.drawer-content');
                const lastP = instructionsContent.querySelector('p:last-of-type');
                lastP.innerHTML = "<strong>Challenge:</strong> Every 10 seconds, one random die will change its letter! <strong>Every 8 seconds</strong>, two adjacent tiles will swap positions!";
                
                // Check for mobile device and set print letters on by default for small screens
                if (window.innerWidth < 600 && !showPrintLetters) {
                    printLettersToggle.checked = true;
                    printLettersToggle.dispatchEvent(new Event('change'));
                }
                
                // Set up audio context properly for iOS
                document.addEventListener('touchstart', function() {
                    if (audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                }, { once: true });
                
                // Force timer reset after a slight delay to ensure DOM is fully loaded
                setTimeout(function() {
                    // Clear any previous timers
                    if (swapTimer) {
                        clearInterval(swapTimer);
                    }
                    
                    // Set up a new timer with exactly 8000ms interval
                    swapTimer = setInterval(function() {
                        console.log("8-SECOND TIMER TRIGGERED");
                        swapAdjacentTiles();
                    }, 8000);
                    
                    console.log("SWAP TIMER RESET TO 8 SECONDS ON PAGE LOAD");
                }, 1000);
            };
        });
    </script>
</body>
</html>